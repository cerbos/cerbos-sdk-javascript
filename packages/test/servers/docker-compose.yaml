name: cerbos-sdk-javascript-test

services:
  certificates:
    image: ruby:3.2-alpine
    entrypoint: /generate-certificates
    volumes:
      - type: bind
        source: generate-certificates
        target: /generate-certificates
        read_only: true
      - type: bind
        source: tmp/certificates
        target: /certificates

  plaintext:
    image: ghcr.io/cerbos/cerbos:${CERBOS_IMAGE_TAG:-$CERBOS_VERSION}
    environment:
      - CERBOS_CONFIG=/config/plaintext.yaml
    healthcheck:
      interval: 2s
    ports:
      - 3592
      - 3593
    user: ${USER}
    volumes:
      - type: bind
        source: config/cerbos/${CONFIG_VERSION}
        target: /config
        read_only: true
      - type: bind
        source: policies/${POLICIES_VERSION}
        target: /policies
        read_only: true

  socket:
    profiles:
      - linux
    extends: plaintext
    environment:
      - CERBOS_CONFIG=/config/socket.yaml
    volumes:
      - type: bind
        source: tmp/socket
        target: /socket

  tls:
    extends: plaintext
    environment:
      - CERBOS_CONFIG=/config/tls.yaml
    volumes:
      - type: bind
        source: tmp/certificates
        target: /certificates
        read_only: true
    depends_on:
      certificates:
        condition: service_completed_successfully

  mtls:
    image: traefik:2.10
    command:
      - --entrypoints.grpc.address=:3593
      - --ping
      - --providers.file.filename=/config/traefik/mtls.yaml
    healthcheck:
      interval: 2s
      timeout: 1s
      test:
        - CMD
        - traefik
        - healthcheck
        - --ping
    ports:
      - 3593
    volumes:
      - type: bind
        source: tmp/certificates
        target: /certificates
        read_only: true
      - type: bind
        source: config
        target: /config
        read_only: true
    depends_on:
      certificates:
        condition: service_completed_successfully

  mutable:
    extends: plaintext
    environment:
      - CERBOS_CONFIG=/config/mutable.yaml
    volumes:
      - type: bind
        source: tmp/certificates
        target: /certificates
        read_only: true
    depends_on:
      certificates:
        condition: service_completed_successfully

  tracing:
    profiles:
      - tracing
    extends: plaintext
    environment:
      - CERBOS_CONFIG=/config/tracing.yaml

  otelcol-test:
    profiles:
      - tracing
    build:
      context: ../opentelemetry-collector-test
    ports:
      - 8080
